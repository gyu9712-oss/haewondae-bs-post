<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Openâ€‘Meteo ë‚ ì”¨ ì§€ë„ (í•´ìš´ëŒ€ ì „ìš© Â· ì´ë¥œì°¨ ì˜ˆë°©ìˆ˜ì¹™)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; }
    .legend { position: absolute; z-index: 1000; right: 12px; bottom: 12px; background: rgba(255,255,255,.95); padding: 8px 10px; border-radius: 8px; font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; box-shadow: 0 2px 10px rgba(0,0,0,.1); max-width: 260px; }
    .legend div { display: flex; align-items: center; gap: 6px; margin: 3px 0; }
    .legend .sw { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }
    .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-weight:600; color:#fff }
    .muted { color:#666; font-size:12px }
    pre { white-space: pre-wrap; margin: 6px 0 0; }
    .toolbar { position:absolute; left:12px; top:12px; z-index:1000; background:rgba(255,255,255,.95); padding:8px 10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; display:flex; align-items:center; gap:8px }
    .toolbar button{ cursor:pointer; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:8px }
    .toolbar .dot{ width:8px; height:8px; border-radius:999px; background:#9ca3af; display:inline-block }
  </style>
</head>
<body>
  <div id="map" aria-label="í•´ìš´ëŒ€ ë‚ ì”¨ ë° ì´ë¥œì°¨ ì•ˆì „ ì§€ë„"></div>

  <div class="toolbar" role="group" aria-label="ì§€ë„ ë„êµ¬">
    <button id="refreshBtn" aria-label="ë°ì´í„° ìƒˆë¡œê³ ì¹¨">â†» ìƒˆë¡œê³ ì¹¨</button>
    <span class="dot" id="statusDot" title="ì—°ê²° ìƒíƒœ"></span>
    <span id="updated" class="muted">ì—…ë°ì´íŠ¸ ëŒ€ê¸°â€¦</span>
  </div>

  <div class="legend" aria-live="polite">
    <b>ìœ„í—˜ë„</b>
    <div><span class="sw" style="background:#10b981"></span> ë‚®ìŒ</div>
    <div><span class="sw" style="background:#3b82f6"></span> ë³´í†µ</div>
    <div><span class="sw" style="background:#f59e0b"></span> ì£¼ì˜</div>
    <div><span class="sw" style="background:#dc2626"></span> ê²½ê³„</div>
    <div><span class="sw" style="background:#b91c1c"></span> ì‹¬ê°</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js" crossorigin="anonymous"></script>
  <script>
    // ëª¨ë“  ìì› ë¡œë“œ í›„ ì´ˆê¸°í™”
    window.addEventListener('load', () => {
      try { init(); } catch (e) { showFatal(e); }
    });

    function showFatal(err){
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;inset:12px;z-index:2000;background:rgba(255,255,255,.97);border:1px solid #e5e7eb;border-radius:12px;padding:14px;font:14px system-ui;box-shadow:0 6px 20px rgba(0,0,0,.12)';
      el.innerHTML = `<b>ì§€ë„ë¥¼ í‘œì‹œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</b><br/><span class="muted">ì˜¤ë¥˜: ${err?.message || err}</span>`;
      document.body.appendChild(el);
      console.error(err);
    }

    function init(){
      const KST = 'Asia/Seoul';
      const FETCH_TIMEOUT_MS = 12000;

      // í•´ìš´ëŒ€ë§Œ í‘œì‹œ
      const cities = [ { name: 'í•´ìš´ëŒ€', lat: 35.2183599, lon: 129.1201918 } ];

      const OPEN_METEO = ({lat, lon}) => `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&models=kma_seamless&current=temperature_2m,relative_humidity_2m,is_day,weather_code,rain,showers,snowfall,wind_speed_10m` +
        `&timezone=${encodeURIComponent(KST)}&windspeed_unit=ms`;

      const sleep = (ms) => new Promise(r => setTimeout(r, ms));
      const withTimeout = (p, ms) => Promise.race([ p, new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms)) ]);
      const fmt = (n, dp=0) => (n===undefined || n===null || Number.isNaN(n)) ? '-' : Number(n).toFixed(dp);
      const nowStr = () => new Date().toLocaleString('ko-KR', { timeZone: KST });

      function weatherFromCode(code) {
        if (code === 0) return { main: 'Clear', description: 'ë§‘ìŒ' };
        if ([1,2,3].includes(code)) return { main: 'Clouds', description: code===1?'ëŒ€ì²´ë¡œ ë§‘ìŒ': code===2?'ë¶€ë¶„ íë¦¼':'íë¦¼' };
        if ([45,48].includes(code)) return { main: 'Fog', description: 'ì•ˆê°œ/ì§™ì€ ì•ˆê°œ' };
        if ([51,53,55,56,57].includes(code)) return { main: 'Drizzle', description: 'ì´ìŠ¬ë¹„/ì–¸ ì´ìŠ¬ë¹„' };
        if ([61,63,65,66,67,80,81,82].includes(code)) return { main: 'Rain', description: 'ë¹„/ì†Œë‚˜ê¸°' };
        if ([71,73,75,77,85,86].includes(code)) return { main: 'Snow', description: 'ëˆˆ/ì†Œë‚™ëˆˆ' };
        if ([95,96,99].includes(code)) return { main: 'Thunderstorm', description: 'ë‡Œìš°' };
        return { main: 'Clouds', description: 'íë¦¼' };
      }

      function colorForLevel(level) {
        return level === 'ì‹¬ê°' ? '#b91c1c' : level === 'ê²½ê³„' ? '#dc2626' : level === 'ì£¼ì˜' ? '#f59e0b' : level === 'ë³´í†µ' ? '#3b82f6' : '#10b981';
      }

      function assessHazard({ main, tempC, windMs, rainMm, snowMm }) {
        let level = 'ë³´í†µ';
        let type = main;
        let tips = [];
        const set = (lvl, typ, arr) => { level = lvl; type = typ; tips = arr.slice(); };

        if (main === 'Thunderstorm') {
          set(rainMm > 10 ? 'ì‹¬ê°' : 'ê²½ê³„', 'ë‡Œìš°/í˜¸ìš°', [
            'ê°•í•œ ë¹„Â·ë²ˆê°œ ì‹œ ìš´í–‰ ì¤‘ì§€, ì‹¤ë‚´ ëŒ€ê¸°',
            'ì§€í•˜ì°¨ë„Â·í•˜ì²œ ì¸ê·¼ ì¹¨ìˆ˜ ë„ë¡œ ì§„ì… ê¸ˆì§€',
            'ì‹œì•¼ ê¸‰ê°: ì†ë„ 30% ê°ì†(ë¹„ìƒë“±ì€ ì •ì°¨ ì‹œ ì‚¬ìš©)'
          ]);
        } else if (main === 'Rain' || main === 'Drizzle') {
          set(rainMm > 30 ? 'ì‹¬ê°' : rainMm > 10 ? 'ê²½ê³„' : 'ì£¼ì˜', 'ë¹„/ì –ì€ ë…¸ë©´', [
            'ê°ì†(í‰ì†Œ ëŒ€ë¹„ 20~30%), ì œë™ê±°ë¦¬ 2ë°°',
            'ë§¨í™€Â·ë„ìƒ‰Â·ì² íŒÂ·ë¹—ë¬¼ë°›ì´ ìœ„ í†µê³¼ ê¸ˆì§€',
            'í—¬ë©§ ê¹€ì„œë¦¼ ë°©ì§€, ë°©ìˆ˜ ì¥ê°‘ ì°©ìš©'
          ]);
        } else if (main === 'Snow') {
          set(snowMm > 5 ? 'ê²½ê³„' : 'ì£¼ì˜', 'ëŒ€ì„¤/ê²°ë¹™', [
            'ë¸”ë™ì•„ì´ìŠ¤ ì‹œê°„ëŒ€ ìš´í–‰ ìì œÂ·ê·¼ë¬´ì‹œê°„ ì¡°ì •',
            'ê¸‰ê°€ê°ì† ê¸ˆì§€, ì§ì§„ ì‹œ í›„ë¥œ ì œë™ ë¹„ì¤‘ ë‚®ì¶”ê¸°',
            'ë°©í•œ ì¥ë¹„ ì°©ìš©, ì²´ì˜¨ ì €í•˜ ì‹œ ì¦‰ì‹œ íœ´ì‹'
          ]);
        } else if (main === 'Clear') {
          if (tempC >= 35) {
            set('ê²½ê³„', 'í­ì—¼', [
              '30~60ë¶„ ê°„ê²© ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©',
              'í†µí’í˜• ìì¼“/ì´ë„ˆ, ì¿¨ë§ íƒ€ì›” í™œìš©',
              'ì–´ì§€ëŸ¼Â·ë‘í†µ ë“± ì—´ì§ˆí™˜ ì§•í›„ ì‹œ ì¦‰ì‹œ ì¤‘ì§€'
            ]);
          } else if (tempC >= 33) {
            set('ì£¼ì˜', 'í­ì—¼', [
              'ê·¸ëŠ˜ íœ´ì‹Â·ìˆ˜ë¶„ ë³´ì¶©',
              'ì§„í•œ ìƒ‰/ë‘êº¼ìš´ ì¥ë¹„ í”¼í•˜ê¸°',
              'ì¹´í˜ì¸ ê³¼ë‹¤ì„­ì·¨ ìì œ'
            ]);
          } else if (tempC <= -10) {
            set('ê²½ê³„', 'í•œíŒŒ', [
              'í•¸ë“¤ì›Œë¨¸/í† ì‹œÂ·í•«íŒ©ìœ¼ë¡œ ì† ê°ê° ìœ ì§€',
              'ì•„ì¹¨ êµëŸ‰Â·ê·¸ëŠ˜ê¸¸ ë¸”ë™ì•„ì´ìŠ¤ ì£¼ì˜, ì„œí–‰',
              'ì‹œë™ ì „ íƒ€ì´ì–´ ê³µê¸°ì••Â·ê· ì—´ ì ê²€'
            ]);
          } else {
            set('ë‚®ìŒ', 'ë§‘ìŒ', [ 'PPE(í’€í˜ì´ìŠ¤ í—¬ë©§Â·ì¥ê°‘Â·ë¶€ì¸ Â·ë³´í˜¸ëŒ€) í•„ìˆ˜ ì°©ìš©' ]);
          }
        } else if (main === 'Clouds') {
          set('ë³´í†µ', 'êµ¬ë¦„/ê±´ì¡° ë…¸ë©´', [ 'ê·œì • ì†ë„Â·ì°¨ê°„ê±°ë¦¬ 3ì´ˆ ì´ìƒ, í”¼ë¡œ ëˆ„ì  ì‹œ íœ´ì‹' ]);
        } else if (main === 'Fog') {
          set('ì£¼ì˜', 'ì•ˆê°œ/ë°•ë¬´', [ 'ì €ì† ì£¼í–‰, ìƒì‹œ ë¡œìš°ë¹”/ì•ˆê°œë“±', 'ì°¨í­ ìœ ì§€(ì¤‘ì•™ì„ Â·ê°“ê¸¸ ì ‘ê·¼ ê¸ˆì§€)', 'ì°¨ë¡œ ë³€ê²½ ìµœì†Œí™”, ì°¨ê°„ê±°ë¦¬ 4ì´ˆ+' ]);
        }

        if (windMs >= 14) {
          const windLevel = windMs >= 20 ? 'ì‹¬ê°' : 'ê²½ê³„';
          set(windLevel, 'ê°•í’/ëŒí’', [
            'íš¡í’ êµ¬ê°„(êµëŸ‰Â·í•´ì•ˆÂ·ê³ ê°€) íšŒí”¼, í†µê³¼ ì‹œ ì €ì†Â·ì°¨ë¡œ ì¤‘ì•™',
            'ëŒ€í˜•ì°¨ ì¶”ì›” ê¸ˆì§€(ì™€ë¥˜ ìœ„í—˜), ì ì¬ë¬¼ ì¬ê²°ì†',
            'ì°¨ì²´ë¥¼ ë°”ëŒ ë°©í–¥ìœ¼ë¡œ ì•½ê°„ ê¸°ìš¸ì—¬ ê· í˜• ìœ ì§€'
          ]);
        }

        tips.push('ê³µí†µ: T-CLOCS ì ê²€, PPE ì°©ìš©, ì°¨ê°„ê±°ë¦¬ 3~4ì´ˆ, ì ì¬ ê· í˜• ìœ ì§€');
        return { level, type, tips };
      }

      function incidentInfo({ main, windMs }) {
        let count = 0;
        const cases = [];
        if (main === 'Rain' || main === 'Drizzle' || main === 'Thunderstorm') {
          count += 2;
          cases.push('ë¹—ê¸¸ì— ì–´ë‘ìš´ í™˜ê²½ì—ì„œ ê·€êµ­ ì¤‘, ë„ë¡œ ë…¸ë©´ì˜ ë¬¼ì›…ë©ì´ë¥¼ í”¼í•´ ì°¨ì„ ì˜ ë°”ê¹¥ ìª½ìœ¼ë¡œ ìš´ì „í•˜ë‹¤ ì„œí–‰ì¤‘ì´ë˜ ì˜†ì°¨ì„ ì˜ ìŠ¹ìš©ì°¨ ì‚¬ì´ë“œ ë¯¸ëŸ¬ì™€ ì¶©ëŒí•˜ì—¬ ì´ë¥œì°¨ì™€ ë„˜ì–´ì ¸ í—ˆë¦¬ ë¶€ìƒ ë°œìƒ');
        }
        if (main === 'Snow') {
          count += 1;
          cases.push('ë°°ë‹¬ì„ ìœ„í•´ ì˜¤ë¥´ë§‰ê¸¸ ìš´í–‰ì¤‘, ê²°ë¹™ëœ êµ¬ê°„ì—ì„œ ì´ë¥œì°¨ê°€ ë¯¸ë„ëŸ¬ì§€ë©° ë„˜ì–´ì§');
        }
        if (windMs >= 14) {
          count += 2;
          cases.push("ìš°í¸ë¬¼ì„ ë°°ì†¡í•˜ê³  ê±´ë¬¼ì—ì„œ ë‚˜ì˜¤ëŠ” ì¤‘, íƒœí’ 'ì°¬íˆ¬'ì˜ ì˜í–¥ìœ¼ë¡œ ê°•í•œ ë°”ëŒì´ ë¶ˆì–´ ì„¸ê²Œ ë‹«íˆë ¤ëŠ” í˜„ê´€ë¬¼ì„ ì¡ìœ¼ë ¤ë‹¤ ì™¼ìª½ ì†ëª©ì„ í¬ê²Œ ë¶€ë”ªí˜");
        }
        return { count, cases };
      }

      // ì§€ë„ ìƒì„±
      const map = L.map('map', { tap: false });
      map.setView([35.2183599, 129.1201918], 12);

      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19,
        tileSize: 256
      });
      osm.addTo(map);

      L.control.scale({ metric: true, imperial: false }).addTo(map);

      const markerLayer = L.layerGroup().addTo(map);
      const circleLayer = L.layerGroup().addTo(map);

      const updatedEl = document.getElementById('updated');
      const statusDot = document.getElementById('statusDot');

      function cityPopup({name, wc, temp, humidity, wind, rain, snow, hazard}) {
        const incident = incidentInfo({ main: wc.main, windMs: wind });
        const badge = `<span class="badge" style="background:${colorForLevel(hazard.level)}">${hazard.level}</span>`;
        const incidentBlock = incident.count > 0
          ? `\n<b>âš ï¸ ì•ˆì „ì‚¬ê³  ì •ë³´</b><br/>ì•ˆì „ì‚¬ê³ : <b>${incident.count}ê±´</b><br/>ì‚¬ê³ ì‚¬ë¡€:<pre>${incident.cases.map(c => `- ${c}`).join('\n')}</pre>`
          : '';

        return `ğŸ“ <b>${name}</b><br/>
          ğŸŒ¤ï¸ ìƒíƒœ: ${wc.description} <span style="display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #cfe;color:#456;background:#eef;margin-left:4px">${wc.main}</span><br/>
          ğŸŒ¡ï¸ ê¸°ì˜¨: <b>${fmt(temp,0)}Â°C</b> Â· ğŸ’§ ìŠµë„: ${fmt(humidity,0)}% Â· ğŸŒ¬ï¸ í’ì†: ${fmt(wind,1)} m/s<br/>
          ğŸŒ§ï¸ ê°•ìˆ˜(í˜„ì¬): ${fmt(rain,1)} mm Â· â„ï¸ ì ì„¤(í˜„ì¬): ${fmt(snow,1)} mm<br/><br/>
          <b>ğŸ›¡ï¸ ì´ë¥œì°¨ ì˜ˆë°©ì±…</b> ${badge}<br/>
          ìƒí™© ë¶„ë¥˜: <b>${hazard.type}</b>
          <pre>${hazard.tips.map(t => `- ${t}`).join('\n')}</pre>
          ${incidentBlock}
          <div class="muted">* ë°ì´í„°: Openâ€‘Meteo(kma_seamless) Â· ì‹œê°„ëŒ€: ${KST}</div>`;
      }

      async function fetchCityWeather(city, retries=1) {
        const url = OPEN_METEO(city);
        try {
          statusDot.style.background = '#f59e0b'; // fetching
          const res = await withTimeout(fetch(url, { cache: 'no-store' }), FETCH_TIMEOUT_MS);
          if (!res.ok) throw new Error(`Openâ€‘Meteo ì˜¤ë¥˜: ${res.status}`);
          const data = await res.json();
          const cur = data.current || {};
          const wc = weatherFromCode(cur.weather_code ?? 3);
          const temp = cur.temperature_2m;
          const humidity = cur.relative_humidity_2m;
          const wind = cur.wind_speed_10m;
          const rain = Math.max(cur.rain ?? 0, cur.showers ?? 0);
          const snow = cur.snowfall ?? 0;
          const hazard = assessHazard({ main: wc.main, tempC: temp, windMs: wind, rainMm: rain, snowMm: snow });
          statusDot.style.background = '#10b981'; // success
          return { wc, temp, humidity, wind, rain, snow, hazard };
        } catch (e) {
          if (retries > 0) { await sleep(500); return fetchCityWeather(city, retries-1); }
          statusDot.style.background = '#dc2626'; // error
          throw e;
        }
      }

      function drawCity(city, info) {
        const marker = L.marker([city.lat, city.lon]).addTo(markerLayer);
        marker.bindPopup(cityPopup({ name: city.name, ...info }), { maxWidth: 320 });
        const color = colorForLevel(info.hazard.level);
        L.circleMarker([city.lat, city.lon], { radius: 16, color, fillColor: color, fillOpacity: 0.25 }).addTo(circleLayer);
      }

      async function render(batch = cities) {
        markerLayer.clearLayers();
        circleLayer.clearLayers();
        updatedEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';

        for (const city of batch) {
          try {
            const info = await fetchCityWeather(city);
            drawCity(city, info);
          } catch (e) {
            const m = L.marker([city.lat, city.lon]).addTo(markerLayer);
            m.bindPopup(`âŒ <b>${city.name}</b><br/>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          }
        }
        updatedEl.textContent = `ì—…ë°ì´íŠ¸: ${nowStr()}`;
      }

      document.getElementById('refreshBtn').addEventListener('click', () => render());
      render();
    }
  </script>
</body>
</html>
